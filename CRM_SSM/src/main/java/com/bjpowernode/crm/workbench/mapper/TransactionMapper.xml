<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bjpowernode.crm.workbench.mapper.TransactionMapper" >
  <resultMap id="BaseResultMap" type="com.bjpowernode.crm.workbench.bean.Transaction" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 06 16:20:00 CST 2022.
    -->
    <id column="id" property="id" jdbcType="CHAR" />
    <result column="owner" property="owner" jdbcType="CHAR" />
    <result column="money" property="money" jdbcType="VARCHAR" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="expectedDate" property="expectedDate" jdbcType="CHAR" />
    <result column="customerId" property="customerId" jdbcType="CHAR" />
    <result column="stage" property="stage" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="VARCHAR" />
    <result column="source" property="source" jdbcType="VARCHAR" />
    <result column="activityId" property="activityId" jdbcType="CHAR" />
    <result column="contactsId" property="contactsId" jdbcType="CHAR" />
    <result column="createBy" property="createBy" jdbcType="VARCHAR" />
    <result column="createTime" property="createTime" jdbcType="CHAR" />
    <result column="editBy" property="editBy" jdbcType="VARCHAR" />
    <result column="editTime" property="editTime" jdbcType="CHAR" />
    <result column="description" property="description" jdbcType="VARCHAR" />
    <result column="contactSummary" property="contactSummary" jdbcType="VARCHAR" />
    <result column="nextContactTime" property="nextContactTime" jdbcType="CHAR" />
    <result column="orderNo" property="orderNo" jdbcType="CHAR" />
  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jul 06 16:20:00 CST 2022.
    -->
    id, owner, money, name, expectedDate, customerId, stage, type, source, activityId,
    contactsId, createBy, createTime, editBy, editTime, description, contactSummary,
    nextContactTime
  </sql>

  <insert id="insertTran">
    insert into tbl_tran(
      id,
      owner,
      money,
      name,
      expectedDate,
      customerId,
      stage,
      type,
      source,
      activityId,
      contactsId,
      createBy,
      createTime,
      description,
      contactSummary,
      nextContactTime

    )

    values (
             #{id},
             #{owner},
             #{money},
             #{name},
             #{expectedDate},
             #{customerId},
             #{stage},
             #{type},
             #{source},
             #{activityId},
             #{contactsId},
             #{createBy},
             #{createTime},
             #{description},
             #{contactSummary},
             #{nextContactTime}
           )
  </insert>

    <select id="selectTranByConditionForPage" resultMap="BaseResultMap">
        select
        t.id,
        t.name,
        t.stage,
        t.type,
        t.source,
        c1.name as customerId,
        c2.fullname as contactsId,
        u.name as owner

        from tbl_tran t
        join tbl_user u
        on t.owner=u.id
        join tbl_customer c1
        on t.customerId=c1.id
        join tbl_contacts c2
        on t.contactsId=c2.id

        <where>
            <if test="name!=null and name!=''">
                t.name like '%' #{name} '%'
            </if>

            <if test="contactsId!=null and contactsId!=''">
                and c2.fullname like '%' #{contactsId} '%'
            </if>

            <if test="customerId!=null and customerId!=''">
                and c1.name like '%' #{customerId} '%'
            </if>

            <if test="source!=null and source!=''">
                and t.source = #{source}
            </if>

            <if test="owner!=null and owner!=''">
                and u.name like '%' #{owner} '%'
            </if>

            <if test="stage!=null and stage != ''">
                and t.stage=#{stage}
            </if>

            <if test="type!=null and type != ''">
                and t.type=#{type}
            </if>
        </where>
        order by t.createTime desc
        limit #{pageNo},#{pageSize}
    </select>

    <select id="selectCountOfTranByCondition" resultType="int">
        select
        count(*)
        from tbl_tran t
        join tbl_user u
        on t.owner=u.id
        join tbl_customer c1
        on t.customerId=c1.id
        join tbl_contacts c2
        on t.contactsId=c2.id

        <where>
            <if test="name!=null and name!=''">
                t.name like '%' #{name} '%'
            </if>

            <if test="contactsId!=null and contactsId!=''">
                and c2.fullname like '%' #{contactsId} '%'
            </if>

            <if test="customerId!=null and customerId!=''">
                and c1.name like '%' #{customerId} '%'
            </if>

            <if test="source!=null and source!=''">
                and t.source = #{source}
            </if>

            <if test="owner!=null and owner!=''">
                and u.name like '%' #{owner} '%'
            </if>

            <if test="stage!=null and stage != ''">
                and t.stage=#{stage}
            </if>

            <if test="type!=null and type != ''">
                and t.type=#{type}
            </if>
        </where>
    </select>

    <select id="selectTranForDetailById" resultMap="BaseResultMap">
        select
            t.id,
            u.name as owner,
            t.money,
            t.name,
            t.expectedDate,
            c1.name as customerId,
            t.stage,
            dv.orderNo,
            t.type,
            t.source,
            a.name as activityId,
            c2.fullname as contactsId,
            t.createBy,
            t.createTime,
            t.editBy,
            t.editTime,
            t.description,
            t.contactSummary,
            t.nextContactTime
        from tbl_tran t
                 join tbl_user u
                    on t.owner=u.id
                 join tbl_customer c1
                    on t.customerId=c1.id
                 left join tbl_contacts c2
                    on t.contactsId=c2.id
                 left join tbl_activity a
                    on t.activityId=a.id
                 left join tbl_dic_value dv
                    on t.stage=dv.value
        where t.id=#{id}
    </select>

    <select id="selectCountOfTranGroupByStage" resultType="com.bjpowernode.crm.workbench.bean.FunnelVO">
        select
               count(*) as value,
                stage as name
        from tbl_tran
        group by stage
    </select>
</mapper>
